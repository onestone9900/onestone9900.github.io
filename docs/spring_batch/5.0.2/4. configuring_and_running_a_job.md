---
layout: default
title: 4. Configuring and Running a Job
parent: 5.0.2
grand_parent: SpringBatch
nav_order: 4
---


# 4. Configuring and Running a Job
도메인 섹션에서는, 다음 다이어그램을 가이드로 사용하여, 전체 아키텍처 설계를 논의했다.

![](https://docs.spring.io/spring-batch/docs/current/reference/html/images/spring-batch-reference-model.png)
이미지 7. 배치 개념(Stereotypes)

`잡(Job)` 객체는 스텝(Step)를 위한 단순한 컨테이너처럼 보일 수 있지만 많은 구성 옵션을 알고 있어야 한다. 또한, `잡`을 실행하는 방법과 해당 실행 중에 해당 메타데이터를 저장하는 방법에 대한 많은 옵션을 고려해야 한다. 이 챕터에서는 `잡`의 다양한 구성 옵션 및 런타임 문제에 대해 설명한다.


## 4.1. Configuring a Job
잡 인터페이스에는 여러 구현이 있다. 그러나, 이러한 구현은 제공된 빌더(자바 구성) 또는 XML 네임스페이스(XML 기반 구성) 뒤에서 추상화된다. 다음 예는 자바 및 XML 구성을 모두 보여준다:

`자바 구성`
```
  @Bean
  public Job footballJob(JobRepository jobRepository) {
    return new JobBuilder("footballJob", jobRepository)
                      .start(playerLoad())
                      .next(gameLoad())
                      .next(playerSummarization())
                      .build();
  }
```

`XML 구성`
```
  <job id="footballJob">
    <step id="playerload" parent="s1" next="gameLoad"/>
    <step id="gameLoad" parent="s2" next="playerSummarization"/>
    <step id="playerSummarization" parent="s3"/>
  </job>
```

앞의 예제는 상위(parent) 빈 정의를 사용하여 스텝을 생성한다. 특정 스텝의 세부 정보를 인라인으로 선언할 때의 추가 옵션은 스텝 구성 섹션을 참조하자. XML 네임스페이스는 기본값인 `잡리포지터리(jobRepository)`의 `id`로 리포지터리를 참조한다. 그러나, 이 기본값을 명시적으로 재정의할 수 있다:

```
  <job id="footballJob" job-repository="specialRepository">
    <step id="playerload"          parent="s1" next="gameLoad"/>
    <step id="gameLoad"            parent="s3" next="playerSummarization"/>
    <step id="playerSummarization" parent="s3"/>
  </job>
```

스텝 외에도, 잡 구성에는 병렬화(`<split>`), 선언적 흐름 제어(`<decision>`) 및 흐름 정의의 외부화(`<flow/>`)에 도움이 되는 다른 요소가 포함될 수 있다.


### 4.1.1. Restartability
배치 잡 실행 시 한 가지 중요한 문제는 `잡`의 재시작 동작과 관련이 있다. 특정 `잡인스턴스(JobInstance)`에 대한 `잡익스큐션(JobExecution)`이 이미 존재하는 경우 `잡` 시작은 "재시작"으로 간주한다. 이상적으로, 모든 잡이 중단된 위치에서 시작할 수 있어야 하지만 이것이 불가능한 시나리오가 있다. 이 시나리오에서 새로운 `잡인스턴스`가 생성되었는지 확인하는 것은 전적으로 개발자의 몫이다. 그러나, 스프링 배치에서 약간의 도움을 제공한다. `잡`을 재시작하면 항상 새로운 잡인스턴스의 일부로 실행해야 하는 경우, restartable 프로퍼티를 `false`로 설정할 수 있다. 

다음 예는 XML에서 `restartable` 필드를 `false`로 설정하는 방법을 보여준다: 

`XML 구성`
```
  <job id="footballJob" restartable="false">
    ...
  </job>
```

다음 예는 자바에서 `restartable` 필드를 `false`로 설정하는 방법을 보여준다:

`자바 구성`
```
  @Bean
  public Job footballJob(JobRepository jobRepository) {
      return new JobBuilder("footballJob", jobRepository)
                       .preventRestart()
                       ...
                       .build();
  }
```

다르게 표현하면, `restartable`을 `false`로 설정하면 "이 `잡`은 재시작을 지원하지 않는다"를 의미한다. 재시작할 수 없는 `잡`을 재시작하면 `잡리스타트익셉션(JobRestartException)`이 발생한다. 다음 Junit 코드는 예외를 발생시킨다:

```
  Job job = new SimpleJob();
  job.setRestartable(false);
  JobParameters jobParameters = new JobParameters();
  JobExecution firstExecution = jobRepository.createJobExecution(job, jobParameters);
  jobRepository.saveOrUpdate(firstExecution);
  try {
      jobRepository.createJobExecution(job, jobParameters);
      fail();
  }
  catch (JobRestartException e) {
    // 예외발생
  }
```

재시작할 수 없는 잡에 대한 잡익셉션(JobExecution)을 발생시키려는 첫 번째 시도는 문제가 발생하지 않는다. 그러나, 두 번째 시도에서는 잡리스타트익셉션(JobRestartException)이 발생한다.


### 4.1.2. Intercepting Job Execution
`잡`을 실행하는 동안, 사용자 지정 코드 실행을 위해 다양한 생명주기 이벤트에 대한 알림을 받는 것이 유용할 수 있다. `심플잡(SimpleJob)`은 적절한 위치에서 `잡리스너(JobListener)`를 호출하여 이를 가능하게 한다:

```
  public interface JobExecutionListener {
      void beforeJob(JobExecution jobExecution);
      void afterJob(JobExecution jobExecution);
  }
```

잡에 리스너(listener)를 설정하여 `잡리스너`를 `심플잡`에 추가할 수 있다. 다음 예는 XML 잡 정의에 리스너를 추가하는 방법을 보여준다:

`XML Configuration`
```
  <job id="footballJob">
      <step id="playerload" parent="s1" next="gameLoad"/>
      <step id="gameLoad" parent="s2" next="playerSummarization"/>
      <step id="playerSummarization" parent="s3"/>
      <listeners>
          <listener ref="sampleListener"/>
      </listeners>
  </job>
```

다음 예는 자바 잡 정의에 리스너 메서드를 추가하는 방법을 보여준다:

`Java Configuration`
```
  @Bean
  public Job footballJob(JobRepository jobRepository) {
      return new JobBuilder("footballJob", jobRepository)
                       .listener(sampleListener())
                       ...
                       .build();
  }
```

`afterJob` 메소드는 `잡`의 성공 여부에 관계없이 호출된다. 성공 또는 실패를 결정해야 하는 경우, `잡익스큐션(JobExecution)`에서 해당 정보를 얻을 수 있다:

```
  public void afterJob(JobExecution jobExecution){
    if (jobExecution.getStatus() == BatchStatus.COMPLETED ) {
        //잡 성공
    } else if (jobExecution.getStatus() == BatchStatus.FAILED) {
      //잡 실패
    } 
  }
```

이 인터페이스에 해당하는 주석은 다음과 같다:
- `@BeforeJob`
- `@AfterJob`


### 4.1.3. Inheriting from a Parent Job
자바는 더 나은 재사용 기능을 제공하므로, 이 절에 내용은 XML 기반 구성에서만 사용된다.

유사하지만 동일하지 않은 구성을 가진 잡 그룹의 경우, 구체적인 `잡` 인스턴스가 프로퍼티를 상속할 수 있도록 "상위" `잡`을 정의하는 것이 도움이 될 수 있다. 자바의 클래스 상속과 유사하게, "하위" `잡`은 상위 잡의 요소, 애트리튜트와 결합할 수 있다.

다음 예에서 `baseJob`은 리스너 목록만 정의하는 추상적인 `잡` 정의이다. 다음 예는 `잡(job1)`은 `baseJob`에서 리스너 목록을 상속하고 이를 자체 리스너 목록과 병합하여 2개의 리스너와 1개의 `스텝(step1)`으로 `잡`을 생성한다:

```
  <job id="baseJob" abstract="true">
    <listeners>
      <listener ref="listenerOne"/>
    <listeners>
  </job>
  <job id="job1" parent="baseJob">
    <step id="step1" parent="standaloneStep"/>
    <listeners merge="true">
      <listener ref="listenerTwo"/>
    <listeners>
  </job>
```

자세한 내용은 상위 스텝에서 상속 섹션을 참조하자.


### 4.1.4. JobParametersValidator
XML 네임스페이스에서 선언되거나 `앱스트랙트잡(AbstractJob)`의 하위 클래스(subclass)를 사용하는 잡은 선택적으로 런타임 시 잡 파라미터에 대한 유효성 검사(validator)를 선언할 수 있다. 예를 들어, 모든 필수 파라미터로 잡이 시작되었음을 확인해야 하는 경우 유용하다. 간단한 필수 파라미터와 선택적 파라미터의 조합을 제한하는 데 사용할 수 있는 `디폴트잡파라미터밸리데이터(DefaultJobParametersValidator)`가 있다. 더 복잡한 제약 조건의 경우, 인터페이스(interface)를 직접 구현할 수도 있다.

유효성 검사의 구성은 다음과 같이 자바 빌더를 통해 지원된다:

```
  @Bean
  public Job job1(JobRepository jobRepository) {
      return new JobBuilder("job1", jobRepository)
                       .validator(parametersValidator())
                       ...
                       .build();
  }
```

XML 네임스페이스 지원은 `잡파라미터밸리테이터(JobParametersValidator)` 구성에도 사용할 수 있다:

```
  <job id="job1" parent="baseJob3">
      <step id="step1" parent="standaloneStep"/>
      <validator ref="parametersValidator"/>
  </job>
```

밸리데이터를 참조(reference, 위에 표시된 대로)하거나 빈 네임스페이스의 중첩된 빈 정의로 지정할 수 있다.